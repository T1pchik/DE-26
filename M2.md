- SAMBA
- HQ-SRV
```tcl
echo "server=/au-team.irpo/192.168.3.10" >> /etc/dnsmasq.conf
systemctl restart dnsmasq
```
- BR-SRV
```tcl
if ! grep -q '^nameserver 8\.8\.8\.8$' /etc/resolv.conf; then
    echo 'nameserver 8.8.8.8' | sudo tee -a /etc/resolv.conf
fi
apt-get update && apt-get install wget dos2unix task-samba-dc -y
sleep 3
echo nameserver 192.168.1.10 >> /etc/resolv.conf
sleep 2
echo 192.168.3.10 br-srv.au-team.irpo >> /etc/hosts
rm -rf /etc/samba/smb.conf
samba-tool domain provision --realm=AU-TEAM.IRPO --domain=AU-TEAM --adminpass=P@ssw0rd --dns-backend=SAMBA_INTERNAL --server-role=dc --option='dns forwarder=192.168.1.10'
mv -f /var/lib/samba/private/krb5.conf /etc/krb5.conf
systemctl enable --now samba.service
samba-tool user add hquser1 P@ssw0rd
samba-tool user add hquser2 P@ssw0rd
samba-tool user add hquser3 P@ssw0rd
samba-tool user add hquser4 P@ssw0rd
samba-tool user add hquser5 P@ssw0rd
samba-tool group add hq
samba-tool group addmembers hq hquser1,hquser2,hquser3,hquser4,hquser5
wget https://raw.githubusercontent.com/sudo-project/sudo/main/docs/schema.ActiveDirectory
dos2unix schema.ActiveDirectory
sed -i 's/DC=X/DC=au-team,DC=irpo/g' schema.ActiveDirectory
head -$(grep -B1 -n '^dn:$' schema.ActiveDirectory | head -1 | grep -oP '\d+') schema.ActiveDirectory > first.ldif
tail +$(grep -B1 -n '^dn:$' schema.ActiveDirectory | head -1 | grep -oP '\d+') schema.ActiveDirectory | sed '/^-/d' > second.ldif
ldbadd -H /var/lib/samba/private/sam.ldb first.ldif --option="dsdb:schema update allowed"=true
ldbmodify -v -H /var/lib/samba/private/sam.ldb second.ldif --option="dsdb:schema update allowed"=true
samba-tool ou add 'ou=sudoers'
cat << EOF > sudoRole-object.ldif
dn: CN=prava_hq,OU=sudoers,DC=au-team,DC=irpo
changetype: add
objectClass: top
objectClass: sudoRole
cn: prava_hq
name: prava_hq
sudoUser: %hq
sudoHost: ALL
sudoCommand: /bin/grep
sudoCommand: /bin/cat
sudoCommand: /usr/bin/id
sudoOption: !authenticate
EOF
ldbadd -H /var/lib/samba/private/sam.ldb sudoRole-object.ldif
echo -e "dn: CN=prava_hq,OU=sudoers,DC=au-team,DC=irpo\nchangetype: modify\nreplace: nTSecurityDescriptor" > ntGen.ldif
ldbsearch  -H /var/lib/samba/private/sam.ldb -s base -b 'CN=prava_hq,OU=sudoers,DC=au-team,DC=irpo' 'nTSecurityDescriptor' | sed -n '/^#/d;s/O:DAG:DAD:AI/O:DAG:DAD:AI\(A\;\;RPLCRC\;\;\;AU\)\(A\;\;RPWPCRCCDCLCLORCWOWDSDDTSW\;\;\;SY\)/;3,$p' | sed ':a;N;$!ba;s/\n\s//g' | sed -e 's/.\{78\}/&\n /g' >> ntGen.ldif
ldbmodify -v -H /var/lib/samba/private/sam.ldb ntGen.ldif
```
- HQ-CLI
```tcl
sed -i 's/BOOTPROTO=static/BOOTPROTO=dhcp/' /etc/net/ifaces/ens20/options
systemctl restart network
apt-get update && apt-get install bind-utils -y
system-auth write ad AU-TEAM.IRPO cli AU-TEAM 'administrator' 'P@ssw0rd'
reboot
```
```tcl
apt-get install sudo libsss_sudo -y
control sudo public
sed -i '19 a\
sudo_provider = ad' /etc/sssd/sssd.conf
sed -i 's/services = nss, pam/services = nss, pam, sudo/' /etc/sssd/sssd.conf
sed -i '28 a\
sudoers: files sss' /etc/nsswitch.conf
rm -rf /var/lib/sss/db/*
sss_cache -E
systemctl restart sssd
```
- Raid
- HQ-SRV
```tcl
mdadm --create /dev/md0 --level=0 --raid-devices=2 /dev/sd[b-c]
mdadm --detail -scan --verbose > /etc/mdadm.conf
apt-get update && apt-get install fdisk -y
fdisk /dev/md0 << EOF
n
p
1
2048
4186111
w
EOF

mkfs.ext4 /dev/md0p1
cat << EOF >> /etc/fstab
/dev/md0p1  /raid  ext4  defaults  0  0
EOF

mkdir /raid
mount -a
```
- Nfs
- HQ-SRV
```tcl
apt-get install nfs-server -y
mkdir /raid/nfs
chown 99:99 /raid/nfs
chmod 777 /raid/nfs

cat << EOF >> /etc/exports
/raid/nfs  192.168.2.0/28(rw,sync,no_subtree_check)
EOF
exportfs -a
exportfs -v
systemctl enable nfs
systemctl restart nfs
```
- HQ-CLI
```tcl
apt-get update && apt-get install nfs-clients -y
mkdir -p /mnt/nfs
cat << EOF >> /etc/fstab
192.168.1.10:/raid/nfs  /mnt/nfs  nfs  intr,soft,_netdev,x-systemd.automount  0  0
EOF
mount -a
mount -v
touch /mnt/nfs/test
```
- CHRONY
- ISP
```tcl
apt-get install chrony -y
cat << EOF > /etc/chrony.conf
server 127.0.0.1 iburst prefer
hwtimestamp *
local stratum 5
allow 0/0
EOF
systemctl enable --now chronyd
```
- HQ-CLI
```tcl
apt-get install chrony -y
echo -e 'server 172.16.1.1 iburst prefer' > /etc/chrony.conf
systemctl enable --now chronyd
```
- HQ-SRV
```tcl
apt-get install chrony -y
echo -e 'server 172.16.1.1 iburst prefer' > /etc/chrony.conf
systemctl enable --now chronyd
```
- BR-SRV
```tcl
apt-get install chrony -y
echo -e 'server 172.16.2.1 iburst prefer' > /etc/chrony.conf
systemctl enable --now chronyd
```
- BR-RTR
```tcl
en
conf t
ntp server 172.16.2.1
ntp timezone utc+5
ex
wr me
```
- HQ-RTR
```tcl
en
conf t
ntp server 172.16.1.1 
ntp timezone utc+5
ex
wr me
```
- ANSIBLE
- HQ-CLI
```tcl
useradd remote_user -u 2026
echo -e "P@ssw0rd\nP@ssw0rd" | passwd remote_user
gpasswd -a “remote_user” wheel
sed -i '/WHEEL_USERS.*ALL.*NOPASSWD.*ALL/s/^#//' /etc/sudoers
echo Authorized access only > /etc/openssh/banner
sed -i '1i\Port 2026\nAllowUsers remote_user\nMaxAuthTries 2\nPasswordAuthentication yes\nBanner /etc/openssh/banner' /etc/openssh/sshd_config
systemctl enable --now sshd
systemctl restart sshd
```
- BR-SRV
```tcl
apt-get update
apt-get install ansible -y
cat << EOF >> /etc/ansible/hosts
[servers]
HQ-SRV ansible_host=192.168.1.10
HQ-CLI ansible_host=192.168.2.10
[servers:vars]
ansible_user=remote_user
ansible_port=2026
[routers]
HQ-RTR ansible_host=192.168.1.1
BR-RTR ansible_host=192.168.3.1
[routers:vars]
ansible_user=net_admin
ansible_password=P@ssw0rd
ansible_connection=network_cli
ansible_network_os=ios
EOF
sed -i '10 a\
ansible_python_interpreter=/usr/bin/python3\
interpreter_python=auto_silent\
ansible_host_key_checking=false' /etc/ansible/ansible.cfg
ssh-keygen -f id_rsa -t rsa -N ''
ssh-copy-id -p 2026 sshuser@192.168.1.10
ssh-copy-id -p 2026 sshuser@192.168.2.10
ansible all -m ping
```
- DOCKER
- BR-SRV
```tcl
apt-get update && apt-get install -y docker-compose docker-engine
systemctl enable --now docker
mount -o loop /dev/sr0
docker load -i /media/ALTLinux/docker/site_latest.tar
docker load -i /media/ALTLinux/docker/mariadb_latest.tar
cat << EOF >> /root/site.yml
services:
  db:
    image: mariadb
    container_name: db
    environment:
      DB_NAME: testdb
      DB_USER: test
      DB_PASS: Passw0rd
      MYSQL_ROOT_PASSWORD: Passw0rd
      MYSQL_DATABASE: testdb
      MYSQL_USER: test
      MYSQL_PASSWORD: Passw0rd
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - app_network
    restart: unless-stopped

  testapp:
    image: site
    container_name: testapp
    environment:
      DB_TYPE: maria
      DB_HOST: db
      DB_NAME: testdb
      DB_USER: test
      DB_PASS: Passw0rd
      DB_PORT: 3306
    ports:
      - "8080:8000"
    networks:
      - app_network
    depends_on:
      - db
    restart: unless-stopped

volumes:
  db_data:

networks:
  app_network:
    driver: bridge
EOF
cat << EOF >> launch.sh
docker compose -f site.yml up -d 
sleep 5 
docker exec -it db mysql -u root -pPassw0rd -e "
CREATE DATABASE IF NOT EXISTS testdb;

CREATE USER IF NOT EXISTS 'test'@'%' IDENTIFIED BY 'Passw0rd';

GRANT ALL PRIVILEGES ON testdb.* TO 'test'@'%';

FLUSH PRIVILEGES;"
EOF

chmod +x /root/launch.sh
./launch.sh
```
- WEB
- HQ-SRV
```tcl
apt-get update
apt-get install apache2 php8.2 apache2-mod_php8.2 mariadb-server php8.2-{opcache,curl,gd,intl,mysqli,xml,xmlrpc,ldap,zip,soap,mbstring,json,xmlreader,fileinfo,sodium} -y
systemctl enable --now httpd2 mariadb

mkdir -p /mnt/additional
mount /dev/sr0 /mnt/additional -o ro

mkdir -p /tmp/web_setup
cp -r /mnt/additional/web/* /tmp/web_setup/

mysql -e "CREATE DATABASE webdb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
mysql -e "CREATE USER 'webc'@'localhost' IDENTIFIED BY 'P@ssw0rd';"
mysql -e "GRANT ALL PRIVILEGES ON webdb.* TO 'webc'@'localhost';"
mysql -e "FLUSH PRIVILEGES;"

cd /tmp/web_setup

file -i dump.sql

if file -i dump.sql | grep -q "utf-16"; then
    iconv -f UTF-16 -t UTF-8 dump.sql > dump_utf8.sql
    mysql -u root webdb < dump_utf8.sql
else
    mysql -u root webdb < dump.sql
fi

cp index.php /var/www/html/
cp -r logo.png /var/www/html/

chown -R apache2:apache2 /var/www/html
chmod -R 755 /var/www/html

sed -i "s/\$servername = .*;/\$servername = 'localhost';/" /var/www/html/index.php
sed -i "s/\$dbname = .*;/\$dbname = 'webdb';/" /var/www/html/index.php
sed -i "s/\$password = .*;/\$password = 'P@ssw0rd';/" /var/www/html/index.php
sed -i "s/\$username = .*;/\$username = 'webc';/" /var/www/html/index.php

sed -i 's/\tDirectoryIndex index.html index.cgi index.pl index.php index.xhtml index.htm/\tDirectoryIndex index.php index.html index.cgi index.pl index.xhtml index.htm/' /etc/httpd2/conf/mods-enabled/dir.conf
rm -rf /var/www/html/index.html

systemctl restart httpd2

curl -I http://localhost/
```
- Проброс портов
- HQ-RTR
```tcl
en
conf
ip nat source static tcp 192.168.1.10 80 172.16.1.4 8080
ip nat source static tcp 192.168.1.10 2026 172.16.1.4 2026
end
wr
```
- BR-RTR
```tcl
en
conf
ip nat source static tcp 192.168.3.10 8080 172.16.2.5 8080
ip nat source static tcp 192.168.3.10 2026 172.16.2.5 2026
end
wr
```
- Nginx
- ISP
```tcl
apt-get install nginx -y
sleep 4
cat << EOF >> /etc/nginx/sites-available.d/proxy.conf
server {
    listen 80;
    server_name web.au-team.irpo;
    
    location / {
        proxy_pass http://172.16.1.4:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

server {
    listen 80;
    server_name docker.au-team.irpo;
    
    location / {
        proxy_pass http://172.16.2.5:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
EOF
ln -s /etc/nginx/sites-available.d/proxy.conf /etc/nginx/sites-enabled.d/
mv /etc/nginx/sites-available.d/default.conf /root/
systemctl enable --now nginx
systemctl restart nginx
```
