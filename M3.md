## 7. Zabbix
- HQ-SRV
```tcl
sed -i '1i address=/mon.au-team.irpo/192.168.1.10' /etc/dnsmasq.conf
systemctl restart dnsmasq
apt-get update
apt-get install -y docker-engine docker-compose-v2 
systemctl enable --now docker
docker pull mariadb
docker pull postgres
tee /root/zabbix.yml > /dev/null << 'EOF'
services:
  zabbix-postgres:
    container_name: zabbix-postgres
    image: postgres:16
    volumes:
      - postgres-zabbix:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: zabbix
      POSTGRES_USER: zabbix
      POSTGRES_PASSWORD: zabbix
    restart: unless-stopped
  zabbix-server:
    container_name: zabbix-server
    image: zabbix/zabbix-server-pgsql
    environment:
      DB_SERVER_HOST: zabbix-postgres
      DB_SERVER_PORT: 5432
      POSTGRES_DB: zabbix
      POSTGRES_USER: zabbix
      POSTGRES_PASSWORD: zabbix
    ports:
      - "10051:10051"
    restart: unless-stopped
    depends_on:
      - zabbix-postgres
  zabbix-web:
    container_name: zabbix-web
    image: zabbix/zabbix-web-nginx-pgsql
    environment:
      DB_SERVER_HOST: zabbix-postgres
      DB_SERVER_PORT: 5432
      POSTGRES_DB: zabbix
      POSTGRES_USER: zabbix
      POSTGRES_PASSWORD: zabbix
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_PORT: 10051
      PHP_TZ: Asia/Yekaterinburg
    ports:
      - "8080:8080"
    restart: unless-stopped
    depends_on:
      - zabbix-postgres
volumes:
  postgres-zabbix:
EOF
docker compose -f zabbix.yml up -d
apt-get update
apt-get install -y apache2
NEW_PASS_HASH=$(htpasswd -bnBC 10 "" "P@ssw0rd" | tr -d ':\n')
docker exec -it zabbix-postgres psql -U zabbix -d zabbix -c "UPDATE users SET passwd = '${NEW_PASS_HASH}' WHERE username = 'Admin';"
apt-get update
apt-get install -y zabbix-agent
sed -i \
  -e 's/^Server=127\.0\.0\.1$/Server=0.0.0.0\/0/' \
  -e 's/^ServerActive=127\.0\.0\.1$/ServerActive=192.168.1.10/' \
  /etc/zabbix/zabbix_agentd.conf
systemctl enable --now zabbix_agentd.service 
systemctl restart zabbix_agentd.service
```
- BR-SRV
```tcl
apt-get update
apt-get install -y zabbix-agent
sed -i \
  -e 's/^Server=127\.0\.0\.1$/Server=0.0.0.0\/0/' \
  -e 's/^ServerActive=127\.0\.0\.1$/ServerActive=192.168.1.10/' \
  /etc/zabbix/zabbix_agentd.conf
systemctl enable --now zabbix_agentd.service 
systemctl restart zabbix_agentd.service
```
- HQ-SRV
```tcl
cat > /tmp/update_ip_direct.sql << 'EOF'
-- Находим интерфейс для хоста "Zabbix server"
SELECT 
    h.host,
    h.hostid,
    i.interfaceid,
    i.ip as old_ip,
    i.port
FROM hosts h
JOIN interface i ON h.hostid = i.hostid
WHERE h.host = 'Zabbix server' 
  AND i.type = 1  -- Agent тип
  AND i.main = 1; -- Основной интерфейс

-- Обновляем IP-адрес
UPDATE interface 
SET ip = '192.168.1.10'
WHERE interfaceid IN (
    SELECT i.interfaceid
    FROM hosts h
    JOIN interface i ON h.hostid = i.hostid
    WHERE h.host = 'Zabbix server' 
      AND i.type = 1
      AND i.main = 1
);

-- Проверяем результат
SELECT 
    h.host,
    i.interfaceid,
    i.ip as new_ip,
    i.port
FROM hosts h
JOIN interface i ON h.hostid = i.hostid
WHERE h.host = 'Zabbix server' 
  AND i.type = 1
  AND i.main = 1;
EOF

echo "Изменение IP через базу данных..."
docker exec -i zabbix-postgres psql -U zabbix -d zabbix < /tmp/update_ip_direct.sql
cat > /tmp/create_both_hosts.sql << 'EOF'
-- Создание двух хостов: hq-srv.au-team.irpo и br-srv.au-team.irpo
WITH 
-- Находим или создаем группу Linux servers
linux_group AS (
    INSERT INTO hstgrp (name)
    SELECT 'Linux servers'
    WHERE NOT EXISTS (SELECT 1 FROM hstgrp WHERE name = 'Linux servers')
    RETURNING groupid
),
-- Находим шаблон Linux by Zabbix agent
linux_template AS (
    SELECT hostid FROM hosts 
    WHERE host = 'Linux by Zabbix agent' AND status = 3
    LIMIT 1
),
-- Создаем хосты (если не существуют)
new_hosts AS (
    INSERT INTO hosts (hostid, host, name, status, flags)
    SELECT 
        (SELECT MAX(hostid) FROM hosts) + ROW_NUMBER() OVER (ORDER BY host_name),
        host_name,
        host_name,
        0, -- monitored
        0  -- plain host
    FROM (VALUES 
        ('hq-srv.au-team.irpo'),
        ('br-srv.au-team.irpo')
    ) AS hosts_list(host_name)
    WHERE NOT EXISTS (SELECT 1 FROM hosts h WHERE h.host = hosts_list.host_name)
    RETURNING hostid, host
)
-- Создаем интерфейсы для хостов
INSERT INTO interface (interfaceid, hostid, type, main, useip, ip, port)
SELECT 
    (SELECT MAX(interfaceid) FROM interface) + ROW_NUMBER() OVER (ORDER BY nh.host),
    nh.hostid,
    1, -- agent
    1, -- main
    1, -- useip
    CASE 
        WHEN nh.host = 'hq-srv.au-team.irpo' THEN '192.168.1.10'
        WHEN nh.host = 'br-srv.au-team.irpo' THEN '192.168.3.10'
    END,
    '10050'
FROM new_hosts nh
WHERE nh.hostid IS NOT NULL;

-- Привязываем хосты к группе Linux servers
INSERT INTO hosts_groups (hostgroupid, hostid, groupid)
SELECT 
    (SELECT MAX(hostgroupid) FROM hosts_groups) + ROW_NUMBER() OVER (ORDER BY h.host),
    h.hostid,
    g.groupid
FROM hosts h
CROSS JOIN (SELECT groupid FROM hstgrp WHERE name = 'Linux servers' LIMIT 1) g
WHERE h.host IN ('hq-srv.au-team.irpo', 'br-srv.au-team.irpo')
  AND NOT EXISTS (
    SELECT 1 FROM hosts_groups hg 
    WHERE hg.hostid = h.hostid AND hg.groupid = g.groupid
  );

-- Привязываем шаблон Linux by Zabbix agent
INSERT INTO hosts_templates (hosttemplateid, hostid, templateid)
SELECT 
    (SELECT MAX(hosttemplateid) FROM hosts_templates) + ROW_NUMBER() OVER (ORDER BY h.host),
    h.hostid,
    t.hostid
FROM hosts h
CROSS JOIN (SELECT hostid FROM hosts WHERE host = 'Linux by Zabbix agent' AND status = 3 LIMIT 1) t
WHERE h.host IN ('hq-srv.au-team.irpo', 'br-srv.au-team.irpo')
  AND NOT EXISTS (
    SELECT 1 FROM hosts_templates ht 
    WHERE ht.hostid = h.hostid AND ht.templateid = t.hostid
  );

-- Создаем записи в host_inventory
INSERT INTO host_inventory (hostid)
SELECT hostid FROM hosts 
WHERE host IN ('hq-srv.au-team.irpo', 'br-srv.au-team.irpo')
  AND NOT EXISTS (SELECT 1 FROM host_inventory hi WHERE hi.hostid = hosts.hostid);

-- Результат
SELECT 
    '✅ Хосты успешно созданы:' as result
UNION ALL
SELECT '   hq-srv.au-team.irpo - 192.168.1.10'
UNION ALL
SELECT '   br-srv.au-team.irpo - 192.168.3.10'
UNION ALL
SELECT '   Группа: Linux servers'
UNION ALL
SELECT '   Шаблон: Linux by Zabbix agent';
EOF

echo "Создание хостов hq-srv.au-team.irpo и br-srv.au-team.irpo..."
docker exec -i zabbix-postgres psql -U zabbix -d zabbix < /tmp/create_both_hosts.sql

echo ""
echo "Проверка созданных хостов..."
cat > /tmp/check_both_hosts.sql << 'EOF'
SELECT 
    h.host as "Имя хоста",
    h.hostid as "ID хоста",
    CASE h.status 
        WHEN 0 THEN 'Мониторится'
        WHEN 1 THEN 'Не мониторится'
        ELSE 'Неизвестно'
    END as "Статус",
    i.ip as "IP адрес",
    i.port as "Порт",
    g.name as "Группа",
    t.host as "Шаблон"
FROM hosts h
LEFT JOIN interface i ON h.hostid = i.hostid AND i.main = 1
LEFT JOIN hosts_groups hg ON h.hostid = hg.hostid
LEFT JOIN hstgrp g ON hg.groupid = g.groupid
LEFT JOIN hosts_templates ht ON h.hostid = ht.hostid
LEFT JOIN hosts t ON ht.templateid = t.hostid AND t.status = 3
WHERE h.host IN ('hq-srv.au-team.irpo', 'br-srv.au-team.irpo')
ORDER BY h.host;
EOF

docker exec -i zabbix-postgres psql -U zabbix -d zabbix < /tmp/check_both_hosts.sql

echo ""
echo "✅ Оба хоста успешно созданы!"
echo ""
echo "Проверьте в веб-интерфейсе Zabbix:"
echo "http://$(hostname -I | awk '{print $1}'):8080"
echo "Configuration → Hosts"
echo ""
echo "Очистка временных файлов..."
rm -f /tmp/create_both_hosts.sql /tmp/check_both_hosts.sql
echo "Готово!"
```
