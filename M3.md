## 7. Zabbix
- HQ-SRV
```tcl
sudo sed -i '1i address=/mon.au-team.irpo/192.168.1.10' /etc/dnsmasq.conf
systemctl restart dnsmasq
apt-get update
apt-get install -y docker-engine docker-compose-v2 
systemctl enable --now docker
docker pull mariadb
docker pull postgres
tee /root/zabbix.yml > /dev/null << 'EOF'
services:
  zabbix-postgres:
    container_name: zabbix-postgres
    image: postgres:16
    volumes:
      - postgres-zabbix:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: zabbix
      POSTGRES_USER: zabbix
      POSTGRES_PASSWORD: zabbix
    restart: unless-stopped
  zabbix-server:
    container_name: zabbix-server
    image: zabbix/zabbix-server-pgsql
    environment:
      DB_SERVER_HOST: zabbix-postgres
      DB_SERVER_PORT: 5432
      POSTGRES_DB: zabbix
      POSTGRES_USER: zabbix
      POSTGRES_PASSWORD: zabbix
    ports:
      - "10051:10051"
    restart: unless-stopped
    depends_on:
      - zabbix-postgres
  zabbix-web:
    container_name: zabbix-web
    image: zabbix/zabbix-web-nginx-pgsql
    environment:
      DB_SERVER_HOST: zabbix-postgres
      DB_SERVER_PORT: 5432
      POSTGRES_DB: zabbix
      POSTGRES_USER: zabbix
      POSTGRES_PASSWORD: zabbix
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_PORT: 10051
      PHP_TZ: Asia/Yekaterinburg
    ports:
      - "8080:8080"
    restart: unless-stopped
    depends_on:
      - zabbix-postgres
volumes:
  postgres-zabbix:
EOF
docker compose -f zabbix.yml up -d
apt-get update
apt-get install -y apache2
NEW_PASS_HASH=$(htpasswd -bnBC 10 "" "P@ssw0rd" | tr -d ':\n')
docker exec -it zabbix-postgres psql -U zabbix -d zabbix -c "UPDATE users SET passwd = '${NEW_PASS_HASH}' WHERE username = 'Admin';"
```
- HQ-SRV / BR-SRV
```tcl
apt-get update
apt-get install -y zabbix-agent
sed -i \
  -e 's/^Server=127\.0\.0\.1$/Server=0.0.0.0\/0/' \
  -e 's/^ServerActive=127\.0\.0\.1$/ServerActive=192.168.1.10/' \
  /etc/zabbix/zabbix_agentd.conf
systemctl enable --now zabbix_agentd.service 
systemctl restart zabbix_agentd.service
```
- HQ-SRV
```tcl

```
- HQ-SRV
```tcl
cat > /tmp/update_ip_direct.sql << 'EOF'
-- Находим интерфейс для хоста "Zabbix server"
SELECT 
    h.host,
    h.hostid,
    i.interfaceid,
    i.ip as old_ip,
    i.port
FROM hosts h
JOIN interface i ON h.hostid = i.hostid
WHERE h.host = 'Zabbix server' 
  AND i.type = 1  -- Agent тип
  AND i.main = 1; -- Основной интерфейс

-- Обновляем IP-адрес
UPDATE interface 
SET ip = '192.168.1.10'
WHERE interfaceid IN (
    SELECT i.interfaceid
    FROM hosts h
    JOIN interface i ON h.hostid = i.hostid
    WHERE h.host = 'Zabbix server' 
      AND i.type = 1
      AND i.main = 1
);

-- Проверяем результат
SELECT 
    h.host,
    i.interfaceid,
    i.ip as new_ip,
    i.port
FROM hosts h
JOIN interface i ON h.hostid = i.hostid
WHERE h.host = 'Zabbix server' 
  AND i.type = 1
  AND i.main = 1;
EOF

echo "Изменение IP через базу данных..."
docker exec -i zabbix-postgres psql -U zabbix -d zabbix < /tmp/update_ip_direct.sql
```
